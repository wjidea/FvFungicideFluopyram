---
title: "2015 fungicide manuscript"
author: "Jie Wang"
date: "December 15, 2015"
output: html_document
---
#Part I Poison Plate Assay
## 1, Background
_Fusarium virguliforme_ is a soilborne soybean pathogen infected and colonized
in soybean roots. Disease management strategies are still lacking to deal with
this devastating diseases. Seed treatment with fungicide seem to be promising in
numerous disease management, however it was nevel tried on _F. virguliforme_ in
the past. In this study, the SDHI fungicide, fluopyram, was used to evaluate
the response of _F. virguliforme_ response to fluopyram fungicide treatment.

## 2, Objectives
- baseline sensitivity of _F. virguliforme_ response to fluopyram
- different methods (similarity and differences)
- Fitness of the data with the model
- differences among different demography data

## 3, Dependencies and data descriptions
Load required dependencies.  
How data were collected, organized, and stored in the directory.

### 1) load dependencies
```{r load dependencies, echo = FALSE,  message = FALSE}
options(digits = 3,scipen = 999, max.print = 500)
library("drc")
library("ggplot2")
library("dplyr")
library("stringr")
# library("beeswarm")
library("latticeExtra")
library("knitr")

# Customized functions
# trim leading and trailling space, "|" is a boolean "OR"
trim <- function (x) gsub("^\\s+|\\s+$", "", x)

# convert factors to numeric and suppose to be an efficient way
as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}

# calculate standard err
se <- function(x) sd(x)/sqrt(length(x))
# se(c(1,2,3,4))
```

### 2) import data and manipulations
```{r import data plate, echo = FALSE,  message = FALSE}
dataPath <- file.path("/Users/wjidea/GoogleDrive/Graduate_Study",
                      "0_Research_projects/5_Fungicide_project",
                      "0_2014_Bayer_fluopyram/FvFungicideFluopyram/Data")
# filesPlateNames <- dir(dataPlatePath, pattern = "^fungal_set[0-9]*$")
fileList <- list.files(path = dataPath, full.names = TRUE, 
                       pattern = "^fungal_set[0-9]*$")
listPlate <- lapply(fileList, read.table, header = TRUE, sep="\t")
listPlate <- na.omit(listPlate)

# rbind all the data lists
fullPlateData <- plyr::ldply(listPlate, data.frame)

# strip space in the strain name
fullPlateData$Strain <- trim(fullPlateData$Strain)

# change other wrong names
fullPlateData$Strain[fullPlateData$Strain == "Mont1_GH"] <- "Mont1"

# change to factors for different sets of run
fullPlateData$Set <- as.factor(fullPlateData$Set)

# set strain and set name combination
fullPlateData$setStrain <- paste(fullPlateData$Set,
                                 fullPlateData$Strain, sep="@")
fullPlateData$setStrain <- factor(fullPlateData$setStrain)

# calculate colony growth rate
fullPlateData$growthRate <- (sqrt(fullPlateData$Area2/pi) - 
                               sqrt(fullPlateData$Area1/pi))/7

# calculate relative growth rate compare to 0 control group
for (strain in fullPlateData$setStrain){
  subData.1 <- fullPlateData[fullPlateData$setStrain == strain,]
  # minConc <- min(as.numeric.factor(subData$Conc))
  controlGrowthRate <- mean(subData.1$growthRate[subData.1$Conc == 0.0])
  fullPlateData$relGrowthRate[fullPlateData$setStrain == strain] <- 
    subData.1$growthRate / controlGrowthRate
}

# detect how many strain that dont have a EC50
# strain growth inhibution less than 50% at the highest fungicide concentration
counter1 <- 0
strainNoEc50 <- c()
for (strain in levels(fullPlateData$setStrain)) {
  if (all(fullPlateData$relGrowthRate[fullPlateData$setStrain == strain] > 0.5)){
    counter1 <- counter1 + 1
    strainNoEc50 <- c(strainNoEc50, strain)
    #cat(paste(counter1,strain,"\n"))
  }
}
fullPlateDataExclude50 <- fullPlateData[!fullPlateData$setStrain %in% strainNoEc50,]
```

### 3) Calculate EC50 for poison plate assay
```{r plate EC50, results = "hide", warning = FALSE, echo = FALSE, cache=TRUE}
# calculate EC50 for each of the strainSet
write2File <- FALSE # write to file?
if (file.exists("./Data/EC50_diameter_diamR.txt") & write2File){
  file.remove("./Data/EC50_diameter_diamR.txt")} 

# create empty list with colNames 
EC50Raw <- data.frame(straiName = character(0), EC50 = numeric(0), 
                      StdErr = numeric(0), Lower = numeric(0), 
                      Upper = numeric(0), pvalue = numeric(0))

# loop through all individual set-Strain names and
# calculate EC50 values seprately
for (strainSet in levels(factor(fullPlateDataExclude50$setStrain)) ){
  # subset data by strain set
  subData <- subset(fullPlateDataExclude50, 
                    subset = fullPlateDataExclude50$setStrain == strainSet)
  subData.m1 <- drm(growthRate ~ Conc, 
                    format(setStrain, trim=TRUE),
                    fct=LL.4(names=c("slope",
                                     "Lower Limit",
                                     "Upper Limit","EC50")),
                    data=subData)
  ED_table <- ED(subData.m1,c(50), interval="delta")
  ModelSummary <- summary(subData.m1)
  # include pvalue along with EC50 calculation
  ED_table_p <- cbind(ED_table,pvalue = ModelSummary$coefficients[4,4])
  EC50Raw <- rbind(EC50Raw, ED_table_p)
  if (write2File){ # if I want to write tab delimited file
    write.table(format(ED_table_p,digits=3,trim=TRUE), eol = "\n",
                "./data/EC50_diameter_diamR.txt", sep = "\t",
                 col.names = FALSE, quote = FALSE, row.names=TRUE)}
}

colnames(EC50Raw) <- c( "EC50", "StdErr", "Lower", "Upper","pvalue")

# split the row setStrain name into two columns PARSE strain names and sets
# strainCols <- do.call(rbind, strsplit(rownames(EC50Sum), "@"))
strainSplitList <- str_split_fixed(rownames(EC50Raw), "@", 2)
strainSplitList <- cbind(strainSplitList, 
                         str_split_fixed(strainSplitList[,2],":",2))
strainSplitList <- strainSplitList[,c(1,3)]
colnames(strainSplitList) <- c("Set","Strain")
EC50Sum <- cbind(EC50Raw, strainSplitList)
rownames(EC50Sum) <- paste(EC50Sum$Strain,EC50Sum$Set,sep = "_")
EC50Sum <- na.exclude(EC50Sum)

# need to filter non-significant EC50 estimations for the EC50 dataframe
# level of significance: alpha = 0.05
EC50SumFilterPlate <- EC50Sum[EC50Sum$pvalue <= 0.05,]

# clean up environment and remove no longer needed objects
rm(subData.m1, strainSet, listPlate, ModelSummary, write2File, fileList)
rm(EC50Sum, EC50Raw, strainSplitList, ED_table, ED_table_p, subData)

# summarize the data into one strain one value
# create empty list with colNames
EC50PlateSum <- data.frame(strainName = character(0), EC50 = numeric(0), 
                              Lower = numeric(0),Upper = numeric(0),
                              StdErr = numeric(0))

for (strainName in sort(levels(factor(EC50SumFilterPlate$Strain)))){
  subDataPlate <- EC50SumFilterPlate[EC50SumFilterPlate$Strain == strainName,]
  tempEC50 <- mean(subDataPlate$EC50)
  if (dim(subDataPlate)[1] > 2){
    lowerEC50 <- tempEC50 - se(subDataPlate$EC50)
    upperEC50 <- tempEC50 + se(subDataPlate$EC50)
    seEC50    <- mean(subDataPlate$StdErr)
  } else {
    lowerEC50 <- min(subDataPlate$Lower)
    upperEC50 <- max(subDataPlate$Upper)
    seEC50    <- mean(subDataPlate$StdErr)
  }
  newDf <- data.frame(strainName = strainName, EC50 = tempEC50, 
                      Lower = lowerEC50,Upper = upperEC50,
                      StdErr = seEC50)
  EC50PlateSum <- rbind(EC50PlateSum, newDf)
}

```

## 4, Results

### 1) Statistics

```{r plate assay statistics}


```



### 2) Figures

####Figure 1 EC50 histogram
```{r Histogram EC50 distrubnution (plate), echo=FALSE}
ggplot(EC50PlateSum, aes(x=EC50)) + 
  geom_histogram(aes(y=(..count..)),
                 # stat = "identity",
                 binwidth=.5, 
                 colour="dark green", fill="white",size=0.9) +
  geom_vline(aes(xintercept=mean(EC50, na.rm=T)),colour="red", 
             linetype="dashed", size=1) + theme_grey() + geom_rug() + 
  scale_x_continuous(breaks=0:12, limits = c(0,10)) + 
  scale_y_continuous(breaks=c(0,5,10,15,20,25,30)) + 
  labs(y="Frequency", x=expression('Fluopyram EC'[50]*' (mg/L)')) +
  theme_classic() +
  theme(axis.text   = element_text(size=14), 
        axis.title  = element_text(size=16),
        axis.text.x = element_text(colour="black"), 
        axis.text.y = element_text(colour="black")) 
```


####Figure 2 Growth curve fit (Plate)
```{r growth curve fit (plate), echo=FALSE, fig.width=10, warning=FALSE}
par(mfrow = c(1,2))
# good fit strains
selStrain2 <- c("12@KSSH_A2","12@MIVB_A5")
selStrain2Data <- fullPlateData[fullPlateData$setStrain %in% selStrain2,]
selStrain2Model <- drm(growthRate~Conc,
                  format(Strain,trim=TRUE),
                  fct=LL.4(names=c("slope","Lower","Upper","EC50")),
                  data=selStrain2Data)
plot(selStrain2Model,type = "all",
     broken = TRUE,
     col = TRUE,
     cex.legend = 0.9,
     level=c("KSSH_A2","MIVB_A5"),
     xlab = expression('Log10 Transformed Fluopyram Concentration (mg/L)'),
     ylab = "Mycelial Growth Rate (cm/d)",
     cex.axis = 1,
     main = "Normal data fit",
     legendPos = c(95,0.14),
     ylim = c(0,0.14))

# bad fit strains
selStrain1 <- c("MIBer_A5", "STJ3a")
selStrain1Data <- fullPlateData[fullPlateData$Strain %in% selStrain1,]
selStrain1Model <- drm(growthRate~Conc,
                  format(Strain,trim=TRUE),
                  fct=LL.4(names=c("slope","Lower","Upper","EC50")),
                  data=selStrain1Data)
plot(selStrain1Model,type = "all",
     broken = TRUE,
     col = TRUE,
     cex.legend = 0.9,
     xlab = expression('Log10 Transformed Fluopyram Concentration (mg/L)'),
     ylab = "Mycelial Growth Rate (cm/d)",
     cex.axis = 1,
     main = "Hormetic effect",
     legendPos = c(95,0.14),
     ylim = c(0,0.14))

rm(selStrain1, selStrain2, selStrain1Data, selStrain2Data)
rm(selStrain1Model,selStrain2Model)
```

####Figure 3 method validation
```{r plate method validation, echo=FALSE}


```

### 3) Other comments

## 5, Notes and comments

```{r write table in file (plate), echo=FALSE}
# write.csv2(EC50SumFilterPlate, file = "./Data/EC50SumPlate.csv",quote = FALSE)

# List all the strains and their EC50 range



```


***

#Part II Conidia Germination Assay

## 1, Dependencies and data descriptions
```{r import data conidia, echo = FALSE,  message = FALSE}
# Prepare data path
conidiaDataPath <- paste(dataPath,"/conidiaAssay.csv",sep="")
conidiaData <- read.csv(conidiaDataPath, header = TRUE)

# gather cols into rows
coniDataFormat <- conidiaData %>% tidyr::gather(Conc, germinate, X0:X100)
levels(coniDataFormat$Conc) <- c(0, 0.01, 0.1, 1, 5, 10, 20, 100)
coniDataFormat$Conc <- as.numeric.factor(coniDataFormat$Conc)
coniNoNaData <- na.exclude(coniDataFormat)
coniNoNaData$setStrain <- with(coniNoNaData, paste(Isolate,Trial,sep="@"))
coniNoNaData$setStrain <- as.factor(coniNoNaData$setStrain)

# calculate relative germinate rate
for (strain in coniNoNaData$setStrain){
  subData.2 <- coniNoNaData[coniNoNaData$setStrain == strain,]
  # minConc <- min(as.numeric.factor(subData$Conc))
  controlGrowthRate <- mean(subData.2$germinate[subData.2$Conc == 0.0])
  coniNoNaData$relGerminate[coniNoNaData$setStrain == strain] <- 
    subData.2$germinate / controlGrowthRate
}

counter2 <- 0
strainNoEc50_conidia <- c()
for (strain in levels(coniNoNaData$setStrain)) {
  if (all(coniNoNaData$relGerminate[coniNoNaData$setStrain == strain] > 0.5)){
    counter2 <- counter1 + 1
    strainNoEc50_conidia <- c(strainNoEc50_conidia, strain)
    #cat(paste(counter1,strain,"\n"))
  }
}
coniNoNaDataExclude50 <- coniNoNaData[!coniNoNaData$setStrain %in% strainNoEc50_conidia,]
```

### 1) Calculate EC50 for conidia assay
```{r conida EC50, results = "hide", warning = FALSE, cache=TRUE, echo=FALSE}
# create empty list with colNames
EC50Raw <- data.frame(straiName = character(0), EC50 = numeric(0), 
                      StdErr = numeric(0), Lower = numeric(0), 
                      Upper = numeric(0), pvalue = numeric(0))

# loop through all individual set-Strain names and
# calculate EC50 values seprately
for (strainSet in levels(factor(coniNoNaDataExclude50$setStrain)) ){
  # subset data by strain set
  subData <- subset(coniNoNaDataExclude50, 
                    subset = coniNoNaDataExclude50$setStrain == strainSet)
  subData.m1 <- drm(germinate ~ Conc, 
                    format(setStrain, trim=TRUE),
                    fct=LL.4(names=c("slope",
                                     "Lower Limit",
                                     "Upper Limit","EC50")),
                    data=subData)
  ED_table <- ED(subData.m1,c(50), interval="delta")
  ModelSummary <- summary(subData.m1)
  # include pvalue along with EC50 calculation
  ED_table_p <- cbind(ED_table,pvalue = ModelSummary$coefficients[4,4])
  EC50Raw <- rbind(EC50Raw, ED_table_p)
}

colnames(EC50Raw) <- c( "EC50", "StdErr", "Lower", "Upper","pvalue")

# split the row setStrain name into two columns PARSE strain names and sets
# strainCols <- do.call(rbind, strsplit(rownames(EC50Sum), "@"))
strainSplitList <- str_split_fixed(rownames(EC50Raw), "@", 2)
strainSplitList <- cbind(strainSplitList, 
                         str_split_fixed(strainSplitList[,2],":",2))
strainSplitList <- strainSplitList[,c(1,3)]
colnames(strainSplitList) <- c("Strain", "Set")
EC50Sum <- cbind(EC50Raw, strainSplitList)
rownames(EC50Sum) <- paste(EC50Sum$Strain,EC50Sum$Set,sep = "_")
EC50Sum <- na.exclude(EC50Sum)

# need to filter non-significant EC50 estimations for the EC50 dataframe
# level of significance: alpha = 0.05

EC50SumFilterConidia <- EC50Sum[EC50Sum$pvalue <= 0.05,]

# clean up environment and remove no longer needed objects
rm(subData.m1, strainSet, ModelSummary)
rm(EC50Sum, EC50Raw, strainSplitList, ED_table, ED_table_p, subData)

# summarize the data into one strain one value
# create empty list with colNames
EC50ConidiaSum <- data.frame(strainName = character(0), EC50 = numeric(0), 
                              Lower = numeric(0),Upper = numeric(0),
                             StdErr = numeric(0))

# if one strain was tested for multiple times,
# it needs to be collapsed into 
for (strainName in sort(levels(factor(EC50SumFilterConidia$Strain)))){
  subDataConidia <- EC50SumFilterConidia[EC50SumFilterConidia$Strain == strainName,]
  tempEC50 <- mean(subDataConidia$EC50)
  if (dim(subDataConidia)[1] > 2){
    lowerEC50 <- tempEC50 - se(subDataConidia$EC50)
    upperEC50 <- tempEC50 + se(subDataConidia$EC50)
    seEC50    <- mean(subDataConidia$StdErr)
  }
  else{
    lowerEC50 <- min(subDataConidia$Lower)
    upperEC50 <- max(subDataConidia$Upper)
    seEC50    <- mean(subDataConidia$StdErr)
  }
  newDf <- data.frame(strainName = strainName, EC50 = tempEC50, 
                      Lower = lowerEC50,Upper = upperEC50,
                      StdErr = seEC50)
  EC50ConidiaSum <- rbind(EC50ConidiaSum, newDf)
}
```


### 2) Statistics

```{r conidia assay statistics}


```

####Figure 1 EC50 histogram (conidia)
```{r Histogram EC50 distrubnution (conida), echo=FALSE}
ggplot(EC50ConidiaSum, aes(x=EC50)) + 
  geom_histogram(aes(y=(..count..)),
                 binwidth=.5, 
                 colour="dark green",
                 fill="white",size=0.9) +
  geom_vline(aes(xintercept=mean(EC50, na.rm=T)),colour="red", 
             linetype="dashed", size=1) + theme_grey() + geom_rug() + 
  scale_x_continuous(breaks=0:12, limits = c(0,10)) + 
  scale_y_continuous(breaks=c(0,5,10,15,20,25,30)) + 
  labs(y="Frequency", x=expression('Fluopyram EC'[50]*' (mg/L)')) +
  theme_classic()+
  theme(axis.text   = element_text(size=14), 
        axis.title  = element_text(size=16),
        axis.text.x = element_text(colour="black"), 
        axis.text.y = element_text(colour="black")) 
```


####Figure 2 Growth curve fit (conidia)
```{r growth curve fit (conidia), echo=FALSE, fig.width=5.5, warning=FALSE}
par(mfrow = c(1,1))
# good fit strains
selStrain2 <- c("KSSH-A7@10","LE-11-1@10","LL0059@14")
selStrain2Data <- coniNoNaData[coniNoNaData$setStrain %in% selStrain2,]
selStrain2Model <- drm(germinate~Conc,
                  format(Isolate,trim=TRUE),
                  fct=LL.4(names=c("slope","Lower","Upper","EC50")),
                  data=selStrain2Data)
plot(selStrain2Model,type = "all", broken = TRUE, col = TRUE, cex.legend = 0.9,
     #level=selStrain2,
     xlab = expression('Log10 Transformed Fluopyram Concentration (mg/L)'),
     ylab = "Germinated conidia", cex.axis = 1,
     main = "Normal data fit", ylim = c(0, 50), xlim = c(0,20))
     # legendPos = c(20,0.04))
     #ylim = c(0,0.14))

rm(selStrain1, selStrain2, selStrain1Data, selStrain2Data)
rm(selStrain1Model,selStrain2Model)
```

####Figure 3
```{r Figure 3 EC50 distribution based on state, echo=FALSE, fig.width=7}
# import demographic data for MI and IL experiment
setwd(dataPath)
MIStrainInfo <- read.csv("StrainInfoMI.csv", header = TRUE )
MIStrainInfoSub <- subset(MIStrainInfo, 
                          select = c("isolate","state","county","year"))
ILStrainInfo <- read.csv("StrainInfoIL.csv", header = TRUE )
ILStrainInfoSub <- subset(ILStrainInfo,
                          select = c("IsolateID", "State", "County", "year"))
colnames(ILStrainInfoSub) <- c("isolate","state","county","year")
MIStrainInfoSub <- MIStrainInfoSub[!MIStrainInfoSub$isolate == "13Fv163",]
strainInfoAll <- rbind(ILStrainInfoSub[2:53,], MIStrainInfoSub)

EC50SumFilterPlate$strainName <- do.call(str_replace_all, 
                                 list(EC50SumFilterPlate$Strain, "_", "-"))
EC50SumFilterConidia$strainName <- do.call(str_replace_all, 
                                 list(EC50SumFilterConidia$Strain, "_", "-"))

EC50SumPlateGeoYear <- merge(EC50SumFilterPlate, strainInfoAll, 
                             by.x = "strainName", by.y = "isolate")
EC50SumConidiaGeoYear <- merge(EC50SumFilterConidia, ILStrainInfoSub, 
                               by.x = "strainName", by.y = "isolate")

ggplot(data = EC50SumPlateGeoYear, aes(x = state, y = EC50)) +
  geom_boxplot() + geom_jitter(height = 0)

ggplot(data = EC50SumConidiaGeoYear, aes(x = state, y = EC50)) +
  geom_boxplot() + geom_jitter(height = 0)

```


####Figure 4
```{r Figure 4 compare two methods, echo=FALSE, fig.width=6}

# correct strain name
EC50SumConidiaGeoYear$strainName[EC50SumConidiaGeoYear$strainName == "Mont-1"] <- "Mont1"
# merge two EC50 df
plateEC50Simple <- select(EC50SumPlateGeoYear, strainName, EC50, StdErr, 
                          Lower, Upper) %>% rename(plateEC50 = EC50)
conidiaEC50Simple <- select(EC50SumConidiaGeoYear, strainName, EC50, StdErr, 
                          Lower, Upper) %>% rename(conidiaEC50 = EC50)
# find duplicated run strain names
dupNamePlate <- unique(
  plateEC50Simple$strainName[duplicated(plateEC50Simple$strainName)]
  )
dupNameConidia <- unique(
  conidiaEC50Simple$strainName[duplicated(conidiaEC50Simple$strainName)]
  )
# find unique run strain names
plateEC50SimpleUniq <- 
  plateEC50Simple[!plateEC50Simple$strainName %in% dupNamePlate,]
conidiaEC50SimpleUniq <- 
  conidiaEC50Simple[!conidiaEC50Simple$strainName %in% dupNameConidia,]

# calculate mean, stderr, Lower and Upper for duplicated strain
plateEC50SimpleDupl  <- 
  plateEC50Simple[plateEC50Simple$strainName %in% dupNamePlate,] %>% 
  group_by(strainName) %>% 
  summarise(plateECMean = mean(plateEC50), 
            StdErr = sd(plateEC50) / sqrt(length(plateEC50)),
            Lower = plateECMean - StdErr,
            Upper = plateECMean + StdErr) %>%
  rename(plateEC50 = plateECMean)

conidiaEC50SimpleDupl <- 
  conidiaEC50Simple[conidiaEC50Simple$strainName %in% dupNameConidia,] %>% 
  group_by(strainName) %>% 
  summarise(conidiaECMean = mean(conidiaEC50), 
            StdErr = sd(conidiaEC50) / sqrt(length(conidiaEC50)),
            Lower = conidiaECMean - StdErr,
            Upper = conidiaECMean + StdErr) %>%
  rename(conidiaEC50 = conidiaECMean)

plateEC50 <- rbind(plateEC50SimpleUniq, plateEC50SimpleDupl) %>%
  rename(pEC50 = plateEC50, pSE = StdErr, pL = Lower, pU = Upper)
conidiaEC50 <- rbind(conidiaEC50SimpleUniq, conidiaEC50SimpleDupl) %>%
  rename(cEC50 = conidiaEC50, cSE = StdErr, cL = Lower, cU = Upper)

# relabel row names
rownames(plateEC50) <- 1:length(rownames(plateEC50))
rownames(conidiaEC50) <- 1:length(rownames(conidiaEC50))

compStrainsNames <- merge(plateEC50, conidiaEC50, by = "strainName")$strainName
compPdata <- plateEC50[plateEC50$strainName %in% compStrainsNames, ]
compPdata$assay <- "plate"
colnames(compPdata) <- c("strainName", "EC50", "SE", "Lower", "Upper", "assay")
compCdata <- conidiaEC50[conidiaEC50$strainName %in% compStrainsNames,]
compCdata$assay <- "conidia"
colnames(compCdata) <- c("strainName", "EC50", "SE", "Lower", "Upper", "assay")
compData <- rbind(compPdata, compCdata)

# ggplot(compData, aes(x = strainName, y = EC50, fill=assay)) +
#   geom_bar(aes(fill = assay), stat="identity", 
#            position = position_dodge(width = 0.9)) +
#   geom_errorbar(aes(ymax = EC50 + SE, ymin=EC50 - SE), 
#                 position = position_dodge(width = 0.9), width=0.25) +
#   scale_fill_grey(start = 0.4, end = 0.7) +
#   theme_classic() + labs(x = "Strain names", y = "EC50 estimates (µg/mL)") +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))

xyPlConiData <- merge(plateEC50, conidiaEC50, by = "strainName")
xyPlConiData$PLdiff <- with(xyPlConiData, pEC50 - cEC50)
xyPlConiData$PLdiffU <- with(xyPlConiData, pU - cU)
xyPlConiData$PLdiffL <- with(xyPlConiData, pL - cL)



update(segplot(reorder(strainName, PLdiff) ~ PLdiffL + PLdiffU, data = xyPlConiData, 
        centers = PLdiff, draw.bands = FALSE, 
        #xlab = "Difference between plate and conidia assay EC50 estimate (µg/mL)",
        xlab = expression('Poison plate EC'[50]*' - Conidia assay EC'[50] * ' (µg/mL)'),
        ylab = "Strains") +
  layer(panel.ablineq(v=0, label = NULL, col.line = "grey", x = -0.6, y = 20)))

plot(pEC50~cEC50, data=xyPlConiData, xlab=expression('Conidia assay EC'[50]),
     ylab=expression('Plate assay EC'[50]))
abline(lm(pEC50~cEC50, data=xyPlConiData))
# Lines <- list(bquote(expression(italic("y = 2.553 + 0.357x"))),bquote("Spearman Correlation p = 0.4"))
# mtext(do.call(expression, Lines),side=3,line=1:0)

text(x=3.5, y=3, cex=0.8, label = expression(atop(italic("y = 2.553 + 0.369x"),
                                         "Spearman correlation p = 0.4")))
# lm(pEC50~cEC50, data=xyPlConiData)
cor.test(xyPlConiData$pEC50,xyPlConiData$cEC50, method="spearman")
```


#### Supplimental figures or tables

```{r Tables S1 S2 S3}

EC50PlateSum$Strain <- do.call(str_replace_all, 
                                 list(EC50PlateSum$strainName, "_", "-"))
EC50ConidiaSum$Strain <- do.call(str_replace_all, 
                                 list(EC50ConidiaSum$strainName, "_", "-"))

EC50PlateTable <- merge(EC50PlateSum, strainInfoAll, 
                             by.x = "Strain", by.y = "isolate") %>%
                  select(Strain, state, county, year, EC50, 
                         StdErr, Lower, Upper) %>%
                  rename(State=state, County=county, Year=year)
EC50ConidialTable <- merge(EC50ConidiaSum, ILStrainInfoSub, 
                               by.x = "Strain", by.y = "isolate") %>%
                  select(Strain, state, county, year, EC50, 
                         StdErr, Lower, Upper) %>%
                  rename(State=state, County=county, Year=year)

# EC50PlateTable$Strain[duplicated(EC50PlateTable$Strain)]
# EC50ConidialTable$Strain[duplicated(EC50ConidialTable$Strain)]

kable(EC50PlateTable, 
      caption = "TableS1 EC50 estimation using poison plate mycelial \
      growth inhibition assay")
kable(EC50ConidialTable, 
      caption = "TableS2 EC50 estimation using conidial germination \
      growth inhibition assay")

#Table1 summarized table for strains assay plate assay
sumPlateTable <- EC50PlateTable %>% group_by(State) %>% arrange(Year) %>%
  #filter(!is.na(Year)) %>%
  summarise(N = length(EC50),
            Years = paste(first(Year),"-",last(Year)),
            EC50Range = paste(round(min(EC50),2),"-", round(max(EC50),2))
            )
kable(sumPlateTable,
      caption = "Table1 Geographical and year collection for the F. virguliforme\
      isolates used in this study for the poison plate assay"
      )

#Table2 summarized table for strains assay conidial germination assay
sumConidiaTable <- EC50ConidialTable %>% group_by(State) %>% arrange(Year) %>%
  #filter(!is.na(Year)) %>%
  summarise(N = length(EC50),
            Years = paste(first(Year),"-",last(Year)),
            EC50Range = paste(round(min(EC50),2),"-", round(max(EC50),2))
            )
kable(sumConidiaTable,
      caption = "__Table 2.__ Geographical and year collection for the F. virguliforme\
      isolates used in this study for the conidial germination assay")

# the code I worte below was to generate a table with
# the strains that dont have a absolute EC50. In other words,
# the isolates growth inhibition were higher than 50% even
# at the highest fungicide concentration

plateNoEC50 <- matrix(unlist(strsplit(strainNoEc50,"@")), ncol = 2,
                             byrow = TRUE)[,2]
plateNoEC50 <- unique(plateNoEC50)
repStrainData <- fullPlateDataExclude50[fullPlateDataExclude50$Strain %in% plateNoEC50,]
repStrainNameList <- levels(factor(repStrainData$Strain))
plateNoEC50TableNames <- plateNoEC50[!plateNoEC50 %in% repStrainNameList]
plateNoEC50_replace <- do.call(str_replace_all, list(plateNoEC50TableNames, "_", "-"))
noEC50Table <- strainInfoAll[strainInfoAll$isolate %in% plateNoEC50_replace,,drop=TRUE]
# strainNoEc50_conidia -> 13Fv190
noEC50Table$assay <- "plate"
noEC50TableConidia <- ILStrainInfoSub[ILStrainInfoSub$isolate %in% "13Fv190",]
noEC50TableConidia$assay <- "conidia"
noEC50Table <- rbind(noEC50Table, noEC50TableConidia)
noEC50Table <- noEC50Table %>% rename(Strain = isolate, State = state, 
                                      County = county, Year = year, Assay = assay)
rownames(noEC50Table) <- 1:dim(noEC50Table)[1]
kable(noEC50Table,
      caption = "TableS3 strains were less sensitivity at the highest concentrated\
      fluopyram media in both poison plate assay and conidia germination assay")

```


```{r test reproducibility of the plate assay experiment}

fullPlateData


```

